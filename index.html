<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Hospital System</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; padding-bottom: 50px; }
        
        /* Navigation Bar */
        .navbar { background: #003366; color: white; padding: 15px; display: flex; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-title { font-size: 18px; font-weight: bold; flex-grow: 1; }
        .breadcrumb { font-size: 14px; color: #cbd5e0; margin-top: 5px; }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 10px; display: none; font-size: 16px; }
        .back-btn:hover { background: rgba(255,255,255,0.3); }

        /* Container */
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* --- Level 1 & 2 Styles (Cards) --- */
        .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; border-left: 5px solid transparent; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card.location { border-left-color: #10b981; } 
        .card.patient { border-left-color: #3b82f6; }
        .card-title { font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 5px; }
        .card-sub { color: #666; font-size: 0.9em; }

        .input-group { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .input-group input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        .input-group button { padding: 10px 20px; background: #003366; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }

        /* --- Level 3 Styles (Dashboard) --- */
        .dash-section { background: white; margin-bottom: 1px; transition: all 0.3s; }
        .accordion-header { padding: 15px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .accordion-header:hover { background-color: #f9f9f9; }
        
        .icon { width: 30px; text-align: center; margin-right: 10px; font-size: 20px; }
        .title { flex-grow: 1; font-size: 16px; color: #334e68; font-weight: 500; }
        .arrow { color: #999; font-size: 12px; }

        /* States */
        .dash-section.no-data .accordion-header { opacity: 0.6; background-color: #f8f8f8; filter: grayscale(100%); }
        .dash-section.no-data .title::after { content: ' (Êü•ÁÑ°Ë≥áÊñô)'; font-size: 0.8em; font-weight: normal; margin-left: 5px; color: #999; }
        .dash-section.error-state .title { color: #d9534f; }
        .dash-section.error-state .title::after { content: ' (ËÆÄÂèñÈåØË™§)'; }
        
        .content { display: none; padding: 15px; background-color: #fafafa; border-bottom: 1px solid #eee; }
        .content.show { display: block; }

        /* Content Data Cards */
        .data-card { background: #fff; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 4px; border-left: 4px solid #003366; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .label { color: #888; font-size: 0.9em; }
        .val { font-weight: 500; color: #333; text-align: right; word-break: break-word; max-width: 70%; }
        .sub-items { margin-top: 8px; border-top: 1px dashed #eee; padding-top: 5px; }
        .sub-item-row { display: flex; justify-content: space-between; padding: 2px 0; }

        /* Utils */
        .view-section { display: none; }
        .view-section.active { display: block; }
        .loading { text-align: center; color: #666; padding: 20px; }
        .error { color: #e53e3e; text-align: center; padding: 10px; }
        .empty { text-align: center; color: #aaa; padding: 15px; font-style: italic; }
    </style>
</head>
<body>

    <div class="navbar">
        <button id="btn-back" class="back-btn" onclick="goBack()">‚ùÆ ËøîÂõû</button>
        <div>
            <div class="nav-title" id="nav-title">Smart Hospital</div>
            <div class="breadcrumb" id="breadcrumb">È¶ñÈ†Å</div>
        </div>
    </div>

    <div class="container">
        
        <div id="view-locations" class="view-section active">
            <div class="input-group">
                <input type="text" id="input-org-id" value="669597" placeholder="Ëº∏ÂÖ•Èô¢ÊâÄ‰ª£Á¢º (Organization ID)">
                <button onclick="loadLocations()">Êü•Ë©¢Ë≠∑ÁêÜÁ´ô</button>
            </div>
            <div id="location-list"></div>
        </div>

        <div id="view-patients" class="view-section">
            <h3 id="current-location-name" style="color:#003366; margin-bottom:15px; border-bottom:2px solid #003366; padding-bottom:10px;"></h3>
            <div id="patient-list"></div>
        </div>

        <div id="view-dashboard" class="view-section">
            <div id="dashboard-content"></div>
        </div>

    </div>

    <script>
        let fhirClient = null;
        let navigationStack = []; 
        let currentOrgId = "";
        let currentLocation = null;

        // Definition of Dashboard Sections
        const dashboardSections = [
            { id: "medication", icon: "üíä", title: "Áî®Ëó•Á¥ÄÈåÑ", loader: loadMedications },
            { id: "nursing",    icon: "üë©‚Äç‚öïÔ∏è", title: "Ë≠∑ÁêÜÁ¥ÄÈåÑ", loader: loadNursing },
            { id: "records",    icon: "üè•", title: "ÁóÖÊ≠∑Á¥ÄÈåÑ", loader: loadRecords },
            { id: "lab",        icon: "ü©∏", title: "Ê™¢È©óÂ†±Âëä", loader: loadLab },
            { id: "exam",       icon: "üî¨", title: "Ê™¢Êü•Â†±Âëä", loader: loadExam },
            { id: "surgery",    icon: "üî™", title: "ÊâãË°ìÁ¥ÄÈåÑ", loader: loadSurgery },
            { id: "consult",    icon: "ü©∫", title: "ÊúÉË®∫Á¥ÄÈåÑ", loader: loadConsult },
            { id: "vs",         icon: "üí¨", title: "VS comment", loader: loadVSComment }
        ];

        // Initialize Client
        FHIR.oauth2.ready().then(client => {
            fhirClient = client;
            console.log("FHIR Client Ready");
        }).catch(console.error);


        // --- Navigation Logic ---

        function navigateTo(viewId, title, breadcrumbText) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.getElementById('nav-title').innerText = title;
            document.getElementById('breadcrumb').innerText = breadcrumbText;

            if (viewId === 'view-locations') {
                navigationStack = [];
                document.getElementById('btn-back').style.display = 'none';
            } else {
                document.getElementById('btn-back').style.display = 'inline-block';
            }
        }

        function goBack() {
            const current = document.querySelector('.view-section.active').id;
            if (current === 'view-dashboard') {
                navigateTo('view-patients', currentLocation.name, `È¶ñÈ†Å > ${currentLocation.name}`);
            } else if (current === 'view-patients') {
                navigateTo('view-locations', 'Smart Hospital', 'È¶ñÈ†Å');
            }
        }


        // --- Level 1: Load Locations ---

        async function loadLocations() {
            const orgId = document.getElementById('input-org-id').value;
            if(!orgId) return alert("Ë´ãËº∏ÂÖ•Èô¢ÊâÄ‰ª£Á¢º");
            currentOrgId = orgId;

            const listDiv = document.getElementById('location-list');
            listDiv.innerHTML = '<div class="loading">ÊêúÂ∞ãË≠∑ÁêÜÁ´ô‰∏≠...</div>';

            try {
                const q = `Location?organization=${orgId}&_sort=name`;
                const data = await fhirClient.request(q);
                
                listDiv.innerHTML = '';
                if (!data.entry || data.entry.length === 0) {
                    listDiv.innerHTML = '<div class="empty">Êâæ‰∏çÂà∞Ê≠§Èô¢ÊâÄÁöÑË≠∑ÁêÜÁ´ôË≥áÊñô</div>';
                    return;
                }

                data.entry.forEach(e => {
                    const loc = e.resource;
                    const el = document.createElement('div');
                    el.className = 'card location';
                    el.innerHTML = `
                        <div class="card-title">üè• ${loc.name || 'Unknown'}</div>
                        <div class="card-sub">Type: ${loc.physicalType?.coding?.[0]?.display || 'Ward'}</div>
                    `;
                    el.onclick = () => selectLocation(loc);
                    listDiv.appendChild(el);
                });
            } catch (err) {
                listDiv.innerHTML = `<div class="error">ËÆÄÂèñÂ§±Êïó: ${err.message}</div>`;
            }
        }


        // --- Level 2: Load Patients ---

        async function selectLocation(loc) {
            currentLocation = loc;
            navigateTo('view-patients', loc.name, `È¶ñÈ†Å > ${loc.name}`);
            
            const listDiv = document.getElementById('patient-list');
            document.getElementById('current-location-name').innerText = `üìç ${loc.name} - ‰ΩèÈô¢ÁóÖ‰∫∫Ê∏ÖÂñÆ`;
            listDiv.innerHTML = '<div class="loading">ËÆÄÂèñÁóÖÂ∫äÊ∏ÖÂñÆ‰∏≠...</div>';

            try {
                const q = `Encounter?location=${loc.id}&status=in-progress&_include=Encounter:subject`;
                const data = await fhirClient.request(q);

                listDiv.innerHTML = '';
                if (!data.entry || data.entry.length === 0) {
                    listDiv.innerHTML = '<div class="empty">Ê≠§Ë≠∑ÁêÜÁ´ôÁõÆÂâçÊ≤íÊúâ‰ΩèÈô¢ÁóÖ‰∫∫</div>';
                    return;
                }

                const patients = {};
                data.entry.forEach(e => {
                    if (e.resource.resourceType === 'Patient') patients[`Patient/${e.resource.id}`] = e.resource;
                });

                data.entry.forEach(e => {
                    if (e.resource.resourceType === 'Encounter') {
                        const enc = e.resource;
                        const pt = patients[enc.subject?.reference];
                        if (pt) {
                            const name = pt.name?.[0]?.text || 'Unknown';
                            const el = document.createElement('div');
                            el.className = 'card patient';
                            el.innerHTML = `
                                <div class="card-title">üë§ ${name}</div>
                                <div class="card-sub">ID: ${pt.id} | ÂÖ•Èô¢: ${enc.period?.start?.split('T')[0] || '-'}</div>
                            `;
                            el.onclick = () => selectPatient(pt);
                            listDiv.appendChild(el);
                        }
                    }
                });
            } catch (err) {
                listDiv.innerHTML = `<div class="error">ËÆÄÂèñÂ§±Êïó: ${err.message}</div>`;
            }
        }


        // --- Level 3: Dashboard & All Features ---

        function selectPatient(pt) {
            const ptName = pt.name?.[0]?.text || "Unknown";
            navigateTo('view-dashboard', ptName, `È¶ñÈ†Å > ${currentLocation.name} > ${ptName}`);
            
            const container = document.getElementById('dashboard-content');
            container.innerHTML = ''; // Clear previous

            // Render ALL sections
            dashboardSections.forEach(sec => {
                const html = `
                    <div class="dash-section" id="section-${sec.id}">
                        <div class="accordion-header" onclick="toggleDash('${sec.id}')">
                            <div class="icon">${sec.icon}</div>
                            <div class="title">${sec.title}</div>
                            <div class="arrow">‚ñº</div>
                        </div>
                        <div class="content" id="content-${sec.id}">
                            <div class="loading">ËºâÂÖ•‰∏≠...</div>
                        </div>
                    </div>`;
                container.innerHTML += html;
                
                // Trigger Load for each section
                sec.loader(pt.id, `content-${sec.id}`, `section-${sec.id}`);
            });
        }

        function toggleDash(id) {
            const content = document.getElementById(`content-${id}`);
            content.classList.toggle('show');
        }

        function updateUIState(wrapperId, contentId, html, hasData, isError = false) {
            const wrapper = document.getElementById(wrapperId);
            const content = document.getElementById(contentId);
            
            content.innerHTML = html;
            wrapper.className = "dash-section"; // Reset

            if (isError) {
                wrapper.classList.add("error-state");
            } else if (!hasData) {
                wrapper.classList.add("no-data");
                content.innerHTML = '<div class="empty">Êü•ÁÑ°Ë≥áÊñô</div>';
            } else {
                // Normal state
            }
        }


        // --- Loader Functions (Full Set) ---

        async function loadMedications(ptId, divId, wrapId) {
            try {
                const q = `MedicationRequest?patient=${ptId}&_sort=-date`;
                const data = await fhirClient.request(q);
                const list = data.entry || [];
                
                const html = list.map(e => {
                    const r = e.resource;
                    const dosage = r.dosageInstruction?.[0] || {};
                    const type = dosage.asNeededBoolean ? "PRN" : "Â∏∏Ë¶è";
                    return `
                    <div class="data-card">
                        <div class="data-row"><b style="color:#0056b3">${r.medicationCodeableConcept?.text || 'Drug'}</b> <span>${type}</span></div>
                        <div class="label">${r.authoredOn || '-'} | ${dosage.timing?.code?.text || '-'} | ${dosage.doseAndRate?.[0]?.doseQuantity?.value || '-'}</div>
                    </div>`;
                }).join('');
                updateUIState(wrapId, divId, html, list.length > 0);
            } catch (e) { updateUIState(wrapId, divId, e.message, false, true); }
        }

        async function loadNursing(ptId, divId, wrapId) {
            try {
                const q = `Observation?patient=${ptId}&category=nursing&_sort=-date`;
                const data = await fhirClient.request(q);
                const list = data.entry || [];
                
                const html = list.map(e => `
                    <div class="data-card">
                        <div class="data-row"><b>${e.resource.effectiveDateTime?.split('T')[0]}</b> <span>${e.resource.code?.text}</span></div>
                        <div style="margin-top:5px; color:#555;">${e.resource.valueString || '-'}</div>
                    </div>`).join('');
                updateUIState(wrapId, divId, html, list.length > 0);
            } catch (e) { updateUIState(wrapId, divId, e.message, false, true); }
        }

        async function loadRecords(ptId, divId, wrapId) {
            try {
                const q = `Composition?patient=${ptId}&_sort=-date`;
                const data = await fhirClient.request(q);
                const list = data.entry || [];
                const html = list.map(e => `
                    <div class="data-card">
                        <div class="data-row"><b>${e.resource.type?.text}</b> <span>${e.resource.date?.split('T')[0]}</span></div>
                    </div>`).join('');
                updateUIState(wrapId, divId, html, list.length > 0);
            } catch (e) { updateUIState(wrapId, divId, e.message, false, true); }
        }

        async function loadLab(ptId, divId, wrapId) {
            await loadDiagReport(ptId, divId, wrapId, "LAB");
        }

        async function loadExam(ptId, divId, wrapId) {
            await loadDiagReport(ptId, divId, wrapId, "RAD");
        }

        // Shared function for Lab & Exam
        async function loadDiagReport(ptId, divId, wrapId, cat) {
            try {
                const q = `DiagnosticReport?patient=${ptId}&category=${cat}&_sort=-date&_include=DiagnosticReport:result`;
                const data = await fhirClient.request(q);
                
                // Index observations
                const resources = {};
                if(data.entry) data.entry.forEach(e => resources[e.resource.resourceType + "/" + e.resource.id] = e.resource);
                
                const reports = (data.entry || []).filter(e => e.resource.resourceType === 'DiagnosticReport');

                const html = reports.map(e => {
                    const r = e.resource;
                    const itemsHtml = (r.result || []).map(ref => {
                        const obs = resources[ref.reference];
                        const val = obs ? (obs.valueQuantity ? `${obs.valueQuantity.value} ${obs.valueQuantity.unit}` : obs.valueString) : '-';
                        return `<div class="sub-item-row"><span class="label">${obs?.code?.text || 'Item'}</span><span class="val">${val}</span></div>`;
                    }).join('');
                    
                    return `
                    <div class="data-card">
                        <div class="data-row"><b>${r.code?.text}</b> <span>${r.effectiveDateTime?.split('T')[0]}</span></div>
                        <div class="sub-items">${itemsHtml}</div>
                    </div>`;
                }).join('');
                updateUIState(wrapId, divId, html, reports.length > 0);
            } catch (e) { updateUIState(wrapId, divId, e.message, false, true); }
        }

        async function loadSurgery(ptId, divId, wrapId) {
            try {
                const q = `Procedure?patient=${ptId}&category=surgical&_sort=-date`;
                const data = await fhirClient.request(q);
                const list = data.entry || [];
                const html = list.map(e => `
                    <div class="data-card">
                        <div class="data-row"><b>${e.resource.code?.text}</b> <span>${e.resource.performedDateTime?.split('T')[0]}</span></div>
                        <div class="label">Dr. ${e.resource.performer?.[0]?.actor?.display || '-'}</div>
                    </div>`).join('');
                updateUIState(wrapId, divId, html, list.length > 0);
            } catch (e) { updateUIState(wrapId, divId, e.message, false, true); }
        }

        async function loadConsult(ptId, divId, wrapId) {
            try {
                const q = `ServiceRequest?patient=${ptId}&category=consult&_sort=-date`;
                const data = await fhirClient.request(q);
                const list = data.entry || [];
                const html = list.map(e => `
                    <div class="data-card">
                        <div class="data-row"><b>${e.resource.performerType?.text || 'Consult'}</b> <span>${e.resource.authoredOn?.split('T')[0]}</span></div>
                        <div class="label">Reason: ${e.resource.reasonCode?.[0]?.text || '-'}</div>
                    </div>`).join('');
                updateUIState(wrapId, divId, html, list.length > 0);
            } catch (e) { updateUIState(wrapId, divId, e.message, false, true); }
        }

        async function loadVSComment(ptId, divId, wrapId) {
            try {
                // Example LOINC for progress note
                const q = `Composition?patient=${ptId}&type=http://loinc.org|11506-3&_sort=-date`;
                const data = await fhirClient.request(q);
                const list = data.entry || [];
                const html = list.map(e => {
                    const sectionText = e.resource.section?.[0]?.text?.div?.replace(/<[^>]*>?/gm, '') || "";
                    return `
                    <div class="data-card">
                        <div class="data-row"><b>VS Note</b> <span>${e.resource.date?.split('T')[0]}</span></div>
                        <div style="margin-top:5px; color:#555;">${sectionText}</div>
                    </div>`;
                }).join('');
                updateUIState(wrapId, divId, html, list.length > 0);
            } catch (e) { updateUIState(wrapId, divId, e.message, false, true); }
        }

    </script>
</body>
</html>