<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Level Hospital App</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; }
        
        /* Navigation Bar */
        .navbar { background: #003366; color: white; padding: 15px; display: flex; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-title { font-size: 18px; font-weight: bold; flex-grow: 1; }
        .breadcrumb { font-size: 14px; color: #cbd5e0; margin-top: 5px; }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 10px; display: none; }
        .back-btn:hover { background: rgba(255,255,255,0.3); }

        /* Container */
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* Card Style */
        .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; border-left: 5px solid transparent; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card.location { border-left-color: #10b981; } /* Green for Location */
        .card.patient { border-left-color: #3b82f6; } /* Blue for Patient */
        
        .card-title { font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 5px; }
        .card-sub { color: #666; font-size: 0.9em; }

        /* Input Area */
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .input-group input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        .input-group button { padding: 10px 20px; background: #003366; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }

        /* Views */
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* Existing Dashboard Styles */
        .dashboard-section { background: white; margin-bottom: 1px; }
        .accordion-header { padding: 15px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .accordion-header:hover { background-color: #f9f9f9; }
        .content { display: none; padding: 15px; background-color: #fafafa; border-bottom: 1px solid #eee; }
        .content.show { display: block; }
        .dashboard-data-row { display: flex; justify-content: space-between; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px dashed #eee; }
        
        .loading { text-align: center; color: #666; padding: 20px; }
        .error { color: #e53e3e; text-align: center; padding: 10px; }
        .empty { text-align: center; color: #999; padding: 20px; font-style: italic; }
    </style>
</head>
<body>

    <div class="navbar">
        <button id="btn-back" class="back-btn" onclick="goBack()">â®</button>
        <div>
            <div class="nav-title" id="nav-title">Smart Hospital</div>
            <div class="breadcrumb" id="breadcrumb">é¦–é </div>
        </div>
    </div>

    <div class="container">
        
        <div id="view-locations" class="view-section active">
            <div class="input-group">
                <input type="text" id="input-org-id" value="669597" placeholder="è¼¸å…¥é™¢æ‰€ä»£ç¢¼ (Organization ID)">
                <button onclick="loadLocations()">æŸ¥è©¢è­·ç†ç«™</button>
            </div>
            <div id="location-list"></div>
        </div>

        <div id="view-patients" class="view-section">
            <h3 id="current-location-name" style="color:#003366; margin-bottom:15px;"></h3>
            <div id="patient-list"></div>
        </div>

        <div id="view-dashboard" class="view-section">
            <div id="dashboard-content"></div>
        </div>

    </div>

    <script>
        let fhirClient = null;
        let navigationStack = []; // To handle "Back" button logic
        let currentOrgId = "";
        let currentLocation = null;

        // Initialize Client
        FHIR.oauth2.ready().then(client => {
            fhirClient = client;
            console.log("FHIR Client Ready");
            // Auto-load if preferred, or wait for user to click button
        }).catch(console.error);


        // --- Navigation Logic ---

        function navigateTo(viewId, title, breadcrumbText) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            // Show target
            document.getElementById(viewId).classList.add('active');
            
            // Update Header
            document.getElementById('nav-title').innerText = title;
            document.getElementById('breadcrumb').innerText = breadcrumbText;

            // Manage Stack
            if (viewId === 'view-locations') {
                navigationStack = [];
                document.getElementById('btn-back').style.display = 'none';
            } else {
                navigationStack.push(viewId);
                document.getElementById('btn-back').style.display = 'inline-block';
            }
        }

        function goBack() {
            // Simple logic: If in dashboard, go to patient list. If in patient list, go to locations.
            const current = document.querySelector('.view-section.active').id;
            
            if (current === 'view-dashboard') {
                navigateTo('view-patients', currentLocation.name, `é¦–é  > ${currentLocation.name}`);
            } else if (current === 'view-patients') {
                navigateTo('view-locations', 'Smart Hospital', 'é¦–é ');
            }
        }


        // --- Level 1: Load Locations ---

        async function loadLocations() {
            const orgId = document.getElementById('input-org-id').value;
            if(!orgId) return alert("è«‹è¼¸å…¥é™¢æ‰€ä»£ç¢¼");
            currentOrgId = orgId;

            const listDiv = document.getElementById('location-list');
            listDiv.innerHTML = '<div class="loading">æœå°‹è­·ç†ç«™ä¸­...</div>';

            try {
                // Query: Location belongs to Organization
                // Note: Some sandboxes use 'organization', some use 'managingOrganization'
                const q = `Location?organization=${orgId}&_sort=name`;
                const data = await fhirClient.request(q);
                
                listDiv.innerHTML = '';

                if (!data.entry || data.entry.length === 0) {
                    listDiv.innerHTML = '<div class="empty">æ‰¾ä¸åˆ°æ­¤é™¢æ‰€çš„è­·ç†ç«™è³‡æ–™ (è«‹ç¢ºèª Mock Data æ˜¯å¦å»ºç«‹ Location)</div>';
                    return;
                }

                data.entry.forEach(e => {
                    const loc = e.resource;
                    const el = document.createElement('div');
                    el.className = 'card location';
                    el.innerHTML = `
                        <div class="card-title">ğŸ¥ ${loc.name || 'Unknown Location'}</div>
                        <div class="card-sub">Type: ${loc.physicalType?.coding?.[0]?.display || loc.type?.[0]?.text || 'Ward'} | ID: ${loc.id}</div>
                    `;
                    el.onclick = () => selectLocation(loc);
                    listDiv.appendChild(el);
                });

            } catch (err) {
                listDiv.innerHTML = `<div class="error">è®€å–å¤±æ•—: ${err.message}</div>`;
            }
        }


        // --- Level 2: Load Patients in Location ---

        async function selectLocation(loc) {
            currentLocation = loc;
            navigateTo('view-patients', loc.name, `é¦–é  > ${loc.name}`);
            
            const listDiv = document.getElementById('patient-list');
            document.getElementById('current-location-name').innerText = `ğŸ“ ${loc.name} - ä½é™¢ç—…äººæ¸…å–®`;
            listDiv.innerHTML = '<div class="loading">è®€å–ç—…åºŠæ¸…å–®ä¸­...</div>';

            try {
                // Critical Query: Find Active Encounters in this Location, and include Patient
                const q = `Encounter?location=${loc.id}&status=in-progress&_include=Encounter:subject`;
                const data = await fhirClient.request(q);

                listDiv.innerHTML = '';
                
                if (!data.entry || data.entry.length === 0) {
                    listDiv.innerHTML = '<div class="empty">æ­¤è­·ç†ç«™ç›®å‰æ²’æœ‰ä½é™¢ç—…äºº</div>';
                    return;
                }

                // Process Bundle to map Patient Resource
                const patients = {};
                data.entry.forEach(e => {
                    if (e.resource.resourceType === 'Patient') {
                        patients[`Patient/${e.resource.id}`] = e.resource;
                    }
                });

                // Render Encounters (which act as the "Bed" slot)
                data.entry.forEach(e => {
                    if (e.resource.resourceType === 'Encounter') {
                        const enc = e.resource;
                        const patRef = enc.subject?.reference; // "Patient/123"
                        const pt = patients[patRef];

                        if (pt) {
                            const name = pt.name?.[0]?.text || 'Unknown';
                            const el = document.createElement('div');
                            el.className = 'card patient';
                            el.innerHTML = `
                                <div class="card-title">ğŸ‘¤ ${name}</div>
                                <div class="card-sub">ID: ${pt.id} | å…¥é™¢æ—¥: ${enc.period?.start?.split('T')[0] || '-'}</div>
                            `;
                            el.onclick = () => selectPatient(pt);
                            listDiv.appendChild(el);
                        }
                    }
                });

            } catch (err) {
                listDiv.innerHTML = `<div class="error">è®€å–å¤±æ•—: ${err.message}</div>`;
            }
        }


        // --- Level 3: Patient Dashboard (Reused Logic) ---

        function selectPatient(pt) {
            navigateTo('view-dashboard', pt.name?.[0]?.text, `é¦–é  > ${currentLocation.name} > ${pt.name?.[0]?.text}`);
            
            // Re-render the dashboard structure
            const container = document.getElementById('dashboard-content');
            container.innerHTML = `
                <div class="dashboard-section">
                    <div class="accordion-header" onclick="toggleDash('medication')">
                        <div style="flex-grow:1">ğŸ’Š ç”¨è—¥ç´€éŒ„</div><div id="arrow-medication">â–¼</div>
                    </div>
                    <div class="content" id="content-medication">Loading...</div>
                </div>
                `;

            // Trigger Data Load
            loadMedications(pt.id, 'content-medication');
        }

        function toggleDash(id) {
            const el = document.getElementById(`content-${id}`);
            el.classList.toggle('show');
        }

        // --- Data Loaders (Simplified from previous step) ---

        async function loadMedications(ptId, divId) {
            try {
                const q = `MedicationRequest?patient=${ptId}&_sort=-date`;
                const data = await fhirClient.request(q);
                const list = data.entry || [];
                
                if (list.length === 0) {
                    document.getElementById(divId).innerHTML = '<div class="empty">ç„¡ç”¨è—¥ç´€éŒ„</div>';
                    return;
                }

                const html = list.map(e => {
                    const r = e.resource;
                    const d = r.dosageInstruction?.[0];
                    return `
                        <div class="dashboard-data-row">
                            <b>${r.medicationCodeableConcept?.text}</b>
                            <span>${d?.timing?.code?.text || '-'}</span>
                        </div>`;
                }).join('');
                document.getElementById(divId).innerHTML = html;
            } catch (e) {
                document.getElementById(divId).innerHTML = `<div class="error">${e.message}</div>`;
            }
        }

    </script>
</body>
</html>