<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë°åÂãïÈÜ´ÁôÇ</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; padding-bottom: 50px; }
        
        /* Navigation Bar */
        .navbar { background: #003366; color: white; padding: 15px; display: flex; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-title { font-size: 18px; font-weight: bold; flex-grow: 1; }
        .breadcrumb { font-size: 14px; color: #cbd5e0; margin-top: 5px; }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 10px; display: none; font-size: 16px; }
        .back-btn:hover { background: rgba(255,255,255,0.3); }

        /* Container */
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* General Card Styles */
        .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; border-left: 5px solid transparent; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card.location { border-left-color: #10b981; } 
        .card.patient { border-left-color: #3b82f6; }
        .card-title { font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 5px; }
        .card-sub { color: #666; font-size: 0.9em; }

        /* Input Group */
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .input-group input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        .input-group button { padding: 10px 20px; background: #003366; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }

        /* Category Selection */
        .category-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .cat-btn { background: white; padding: 30px 20px; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s; border: 2px solid transparent; }
        .cat-btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: #003366; }
        .cat-icon { font-size: 40px; margin-bottom: 10px; display: block; }
        .cat-text { font-size: 18px; font-weight: bold; color: #003366; }
        .cat-count { font-size: 12px; color: #888; margin-top: 5px; display: block; }

        /* Dashboard Sections */
        .dash-section { background: white; margin-bottom: 1px; transition: all 0.3s; }
        .accordion-header { padding: 15px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .accordion-header:hover { background-color: #f9f9f9; }
        .icon { width: 30px; text-align: center; margin-right: 10px; font-size: 20px; }
        .title { flex-grow: 1; font-size: 16px; color: #334e68; font-weight: 500; }
        .dash-section.no-data .accordion-header { opacity: 0.6; background-color: #f8f8f8; filter: grayscale(100%); }
        .dash-section.no-data .title::after { content: ' (Êü•ÁÑ°Ë≥áÊñô)'; font-size: 0.8em; font-weight: normal; margin-left: 5px; color: #999; }
        .dash-section.error-state .title { color: #d9534f; }
        .content { display: none; padding: 15px; background-color: #fafafa; border-bottom: 1px solid #eee; }
        .content.show { display: block; }

        /* Data Items */
        .data-card { background: #fff; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 4px; border-left: 4px solid #003366; cursor: pointer; transition: background 0.2s; }
        .data-card:active { background: #eef; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .label { color: #888; font-size: 0.9em; }

        /* Modal Styles */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        .modal-content { background: white; width: 90%; max-width: 600px; border-radius: 12px; padding: 20px; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-title { font-size: 1.2em; font-weight: bold; color: #003366; }
        .close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: #888; line-height: 1; padding: 0 5px; }
        
        .detail-row { margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .detail-label { font-size: 0.9em; color: #888; margin-bottom: 4px; }
        .detail-val { font-size: 1.05em; color: #333; line-height: 1.5; }
        .detail-html { background: #f9f9f9; padding: 10px; border-radius: 4px; border: 1px solid #eee; margin-top: 5px; overflow-x: auto; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* View Utils */
        .view-section { display: none; }
        .view-section.active { display: block; }
        .loading { text-align: center; color: #666; padding: 20px; }
        .empty { text-align: center; color: #aaa; padding: 15px; font-style: italic; }
        .error { color: #d9534f; font-size: 0.9em; }
    </style>
</head>
<body>

    <div class="navbar">
        <button id="btn-back" class="back-btn" onclick="goBack()">‚ùÆ ËøîÂõû</button>
        <div>
            <div class="nav-title" id="nav-title">Ë°åÂãïÈÜ´ÁôÇ</div>
            <div class="breadcrumb" id="breadcrumb">È¶ñÈ†Å</div>
        </div>
    </div>

    <div class="container">
        
        <div id="view-org" class="view-section active">
            <div class="input-group">
                <input type="text" id="input-org-id" value="669597" placeholder="Organization ID">
                <button onclick="confirmOrg()">Á¢∫ÂÆö</button>
            </div>
            <div id="org-loading" class="loading" style="display:none">ËÆÄÂèñÈÜ´Èô¢Ë≥áÊñô‰∏≠ (ÂèØËÉΩÈúÄË¶ÅÂπæÁßíÈêò)...</div>
        </div>

        <div id="view-category" class="view-section">
            <div style="text-align:center; color:#666; margin-bottom:10px;">Ë´ãÈÅ∏ÊìáÊü•Ë©¢È†ÖÁõÆ</div>
            <div class="category-grid">
                <div class="cat-btn" onclick="filterLocations('dept')">
                    <span class="cat-icon">üè•</span>
                    <span class="cat-text">ÁßëÂà•Êü•Ë©¢</span>
                    <span class="cat-count" id="count-dept">Loading...</span>
                </div>
                <div class="cat-btn" onclick="filterLocations('ward')">
                    <span class="cat-icon">üë©‚Äç‚öïÔ∏è</span>
                    <span class="cat-text">Ë≠∑ÁêÜÁ´ôÊü•Ë©¢</span>
                    <span class="cat-count" id="count-ward">Loading...</span>
                </div>
            </div>
        </div>

        <div id="view-locations" class="view-section">
            <h3 id="location-list-title" style="color:#003366; margin-bottom:15px; border-bottom:2px solid #003366; padding-bottom:10px;"></h3>
            <div id="location-list"></div>
        </div>

        <div id="view-patients" class="view-section">
            <h3 id="current-location-name" style="color:#003366; margin-bottom:15px; border-bottom:2px solid #003366; padding-bottom:10px;"></h3>
            <div id="patient-list"></div>
        </div>

        <div id="view-dashboard" class="view-section">
            <div id="dashboard-content"></div>
        </div>
    </div>

    <div id="modal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Ë©≥Á¥∞Ë≥áÊñô</div>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        let fhirClient = null;
        let currentOrgId = "";
        let currentLocation = null;
        let currentPatientResources = {}; 
        
        // Cache
        let allLocationsCache = [];

        const dashboardSections = [
            { id: "medication", icon: "üíä", title: "Áî®Ëó•Á¥ÄÈåÑ", loader: loadMedications },
            { id: "nursing",    icon: "üë©‚Äç‚öïÔ∏è", title: "Ë≠∑ÁêÜÁ¥ÄÈåÑ", loader: loadNursing },
            { id: "records",    icon: "üè•", title: "ÁóÖÊ≠∑Á¥ÄÈåÑ", loader: loadRecords },
            { id: "lab",        icon: "ü©∏", title: "Ê™¢È©óÂ†±Âëä", loader: loadLab },
            { id: "exam",       icon: "üî¨", title: "Ê™¢Êü•Â†±Âëä", loader: loadExam },
            { id: "surgery",    icon: "üî™", title: "ÊâãË°ìÁ¥ÄÈåÑ", loader: loadSurgery },
            { id: "consult",    icon: "ü©∫", title: "ÊúÉË®∫Á¥ÄÈåÑ", loader: loadConsult },
            { id: "vs",         icon: "üí¨", title: "VS comment", loader: loadVSComment }
        ];

        FHIR.oauth2.ready().then(client => {
            fhirClient = client;
            console.log("FHIR Client Ready");
        }).catch(console.error);

        // --- Navigation System ---
        function navigateTo(viewId, title, breadcrumbText) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.getElementById('nav-title').innerText = title;
            document.getElementById('breadcrumb').innerText = breadcrumbText;
            
            const btn = document.getElementById('btn-back');
            if (viewId === 'view-org' || viewId === 'view-category') btn.style.display = 'none';
            else btn.style.display = 'inline-block';
        }

        function goBack() {
            const current = document.querySelector('.view-section.active').id;
            
            if (current === 'view-dashboard') {
                navigateTo('view-patients', currentLocation.name, `È¶ñÈ†Å > ${currentLocation.name}`);
            } 
            else if (current === 'view-patients') {
                navigateTo('view-locations', 'Âú∞ÈªûÊ∏ÖÂñÆ', `È¶ñÈ†Å > ${currentOrgId}`);
            }
            else if (current === 'view-locations') {
                navigateTo('view-category', 'Ë°åÂãïÈÜ´ÁôÇ', `È¶ñÈ†Å > ${currentOrgId}`);
            }
            else if (current === 'view-category') {
                navigateTo('view-org', 'Ë°åÂãïÈÜ´ÁôÇ', 'È¶ñÈ†Å');
                currentOrgId = "";
                allLocationsCache = [];
            }
        }

        // --- Step 1: Confirm Org ---
        async function confirmOrg() {
            const orgId = document.getElementById('input-org-id').value;
            if(!orgId) return alert("Ë´ãËº∏ÂÖ•Èô¢ÊâÄ‰ª£Á¢º");
            currentOrgId = orgId;
            
            document.getElementById('org-loading').style.display = 'block';

            try {
                // FIXED: Added _count=300 to fetch ALL locations, preventing pagination issues
                const q = `Location?organization=${orgId}&_sort=name&_count=300`;
                const data = await fhirClient.request(q);
                allLocationsCache = (data.entry || []).map(e => e.resource);
                
                document.getElementById('org-loading').style.display = 'none';

                if(allLocationsCache.length === 0) {
                    alert("Êü•ÁÑ° Location Ë≥áÊñôÔºåË´ãÁ¢∫Ë™çÊòØÂê¶Â∑≤ÂåØÂÖ•ÂÅáË≥áÊñô");
                    return;
                }
                
                updateCategoryCounts();
                navigateTo('view-category', 'Smart Hospital', `È¶ñÈ†Å > ${orgId}`);
            } catch (err) {
                document.getElementById('org-loading').style.display = 'none';
                alert("ËÆÄÂèñÂ§±Êïó: " + err.message);
            }
        }

        function updateCategoryCounts() {
            const wards = allLocationsCache.filter(l => isWard(l));
            const depts = allLocationsCache.filter(l => !isWard(l));
            document.getElementById('count-ward').innerText = `${wards.length} ÂÄãÂñÆ‰Ωç`;
            document.getElementById('count-dept').innerText = `${depts.length} ÂÄãÁßëÂà•`;
        }

        // Improved Logic: Detect if it's a Ward or Dept
        function isWard(loc) {
            const name = (loc.name || "").toLowerCase();
            // It's a ward if it contains "Ë≠∑ÁêÜÁ´ô", "Ward", "ICU", "Room", or usually starts with a Number (e.g. 7A)
            if (name.includes("Ë≠∑ÁêÜÁ´ô") || name.includes("ward") || name.includes("icu") || name.includes("ÁóÖÊàø")) return true;
            // Additional check: Does it look like "7A", "5B"?
            if (/^[0-9]+[a-zA-Z]/.test(name)) return true;
            return false;
        }

        // --- Step 2: Filter Locations ---
        function filterLocations(type) {
            navigateTo('view-locations', type === 'ward' ? 'Ë≠∑ÁêÜÁ´ôÊ∏ÖÂñÆ' : 'ÁßëÂà•Ê∏ÖÂñÆ', `È¶ñÈ†Å > ${currentOrgId} > ${type==='ward'?'Ë≠∑ÁêÜÁ´ô':'ÁßëÂà•'}`);
            const listDiv = document.getElementById('location-list');
            const titleDiv = document.getElementById('location-list-title');
            
            listDiv.innerHTML = '';
            titleDiv.innerText = type === 'ward' ? 'üë©‚Äç‚öïÔ∏è Ë≠∑ÁêÜÁ´ôÊ∏ÖÂñÆ' : 'üè• ÁßëÂà•Ê∏ÖÂñÆ';

            const filtered = allLocationsCache.filter(loc => {
                return type === 'ward' ? isWard(loc) : !isWard(loc);
            });

            if (filtered.length === 0) {
                listDiv.innerHTML = '<div class="empty">Ê≠§È°ûÂà•ÁÑ°Ë≥áÊñô (Ë´ãÁ¢∫Ë™çÊòØÂê¶Âè™ÂåØÂÖ•‰∫ÜÈÉ®ÂàÜË≥áÊñô)</div>';
                return;
            }

            filtered.forEach(loc => {
                const el = document.createElement('div'); el.className = 'card location';
                el.innerHTML = `
                    <div class="card-title">${type==='ward'?'üõèÔ∏è':'ü©∫'} ${loc.name}</div>
                    <div class="card-sub">${loc.physicalType?.coding?.[0]?.display || 'Location'}</div>`;
                el.onclick = () => selectLocation(loc);
                listDiv.appendChild(el);
            });
        }

        // --- Step 3: Select Location & Load Patients ---
        async function selectLocation(loc) {
            currentLocation = loc;
            navigateTo('view-patients', loc.name, `È¶ñÈ†Å > ${loc.name}`);
            const listDiv = document.getElementById('patient-list');
            document.getElementById('current-location-name').innerText = `üìç ${loc.name} - ÁóÖ‰∫∫Ê∏ÖÂñÆ`;
            listDiv.innerHTML = '<div class="loading">ËÆÄÂèñ‰∏≠...</div>';
            try {
                const q = `Encounter?location=${loc.id}&status=in-progress&_include=Encounter:subject`;
                const data = await fhirClient.request(q);
                listDiv.innerHTML = '';
                if (!data.entry || data.entry.length === 0) return listDiv.innerHTML = '<div class="empty">ÁõÆÂâçÁÑ°ÁóÖ‰∫∫ (Empty)</div>';
                
                const patients = {};
                data.entry.forEach(e => { if (e.resource.resourceType === 'Patient') patients[`Patient/${e.resource.id}`] = e.resource; });
                
                data.entry.forEach(e => {
                    if (e.resource.resourceType === 'Encounter') {
                        const pt = patients[e.resource.subject?.reference];
                        if (pt) {
                            const el = document.createElement('div'); el.className = 'card patient';
                            el.innerHTML = `<div class="card-title">üë§ ${pt.name?.[0]?.text}</div><div class="card-sub">ID: ${pt.id}</div>`;
                            el.onclick = () => selectPatient(pt);
                            listDiv.appendChild(el);
                        }
                    }
                });
            } catch (err) { listDiv.innerHTML = `<div class="error">${err.message}</div>`; }
        }

        // --- Step 4: Dashboard ---
        function selectPatient(pt) {
            currentPatientResources = {};
            const ptName = pt.name?.[0]?.text || "Unknown";
            navigateTo('view-dashboard', ptName, `È¶ñÈ†Å > ${currentLocation.name} > ${ptName}`);
            const container = document.getElementById('dashboard-content');
            container.innerHTML = '';
            dashboardSections.forEach(sec => {
                container.innerHTML += `
                    <div class="dash-section" id="section-${sec.id}">
                        <div class="accordion-header" onclick="toggleDash('${sec.id}')">
                            <div class="icon">${sec.icon}</div>
                            <div class="title">${sec.title}</div>
                        </div>
                        <div class="content" id="content-${sec.id}"><div class="loading">...</div></div>
                    </div>`;
                sec.loader(pt.id, `content-${sec.id}`, `section-${sec.id}`);
            });
        }
        function toggleDash(id) { document.getElementById(`content-${id}`).classList.toggle('show'); }
        
        // --- Modal & Loaders ---
        function openModal(title, htmlContent) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = htmlContent;
            document.getElementById('modal').classList.add('open');
        }
        function closeModal() { document.getElementById('modal').classList.remove('open'); }
        function renderDetailRow(label, value, isHtml = false) {
            if (!value) return '';
            return `<div class="detail-row"><div class="detail-label">${label}</div><div class="${isHtml ? 'detail-html' : 'detail-val'}">${value}</div></div>`;
        }

        // Loaders
        async function loadMedications(ptId, divId, wrapId) {
            try {
                const data = await fhirClient.request(`MedicationRequest?patient=${ptId}&_sort=-date`);
                const list = data.entry || [];
                currentPatientResources['medication'] = list.map(e => e.resource);
                const html = list.map((e, idx) => {
                    const r = e.resource;
                    const d = r.dosageInstruction?.[0] || {};
                    return `<div class="data-card" onclick="showMedDetail(${idx})">
                        <div class="data-row"><b style="color:#0056b3">${r.medicationCodeableConcept?.text}</b> <span>${d.asNeededBoolean ? "PRN" : "Â∏∏Ë¶è"}</span></div>
                        <div class="label">${r.authoredOn || '-'} | ${d.timing?.code?.text || 'QD'}</div>
                    </div>`;
                }).join('');
                updateUI(wrapId, divId, html, list.length);
            } catch (e) { updateUI(wrapId, divId, e.message, 0, true); }
        }
        window.showMedDetail = (idx) => {
            const r = currentPatientResources['medication'][idx];
            const d = r.dosageInstruction?.[0] || {};
            openModal("Áî®Ëó•ÊòéÁ¥∞", `
                ${renderDetailRow("Ëó•ÂìÅÂêçÁ®±", r.medicationCodeableConcept?.text)}
                ${renderDetailRow("ÈñãÁ´ãÊó•Êúü", r.authoredOn)}
                ${renderDetailRow("È†ªÁéá", d.timing?.code?.text)}
                ${renderDetailRow("ÂäëÈáè", `${d.doseAndRate?.[0]?.doseQuantity?.value || ''} ${d.doseAndRate?.[0]?.doseQuantity?.unit || ''}`)}
                ${renderDetailRow("ÊåáÁ§∫", d.text)}
            `);
        };

        async function loadNursing(ptId, divId, wrapId) {
            simpleLoad(ptId, divId, wrapId, 'Observation?category=nursing&_sort=-date', 'nursing',
                (r) => `<div class="data-row"><b>${r.effectiveDateTime?.split('T')[0]}</b> <span>${r.code?.text}</span></div><div class="label">${r.valueString || '-'}</div>`,
                (r) => `${renderDetailRow("ÊôÇÈñì", r.effectiveDateTime?.replace('T',' '))}${renderDetailRow("ÁÑ¶Èªû", r.code?.text)}${renderDetailRow("ÂÖßÂÆπ", r.valueString, true)}`, "Ë≠∑ÁêÜÁ¥ÄÈåÑ"
            );
        }
        async function loadVSComment(ptId, divId, wrapId) {
            try {
                const data = await fhirClient.request(`Composition?patient=${ptId}&type=http://loinc.org|11506-3&_sort=-date`);
                const list = data.entry || [];
                currentPatientResources['vs'] = list.map(e => e.resource);
                const html = list.map((e, idx) => `<div class="data-card" onclick="showVSDetail(${idx})"><div class="data-row"><b>Progress Note</b> <span>${e.resource.date?.split('T')[0]}</span></div><div class="label">${e.resource.author?.[0]?.display || 'Doctor'}</div></div>`).join('');
                updateUI(wrapId, divId, html, list.length);
            } catch (e) { updateUI(wrapId, divId, e.message, 0, true); }
        }
        window.showVSDetail = (idx) => {
            const r = currentPatientResources['vs'][idx];
            openModal("Progress Note", `${renderDetailRow("ÊôÇÈñì", r.date?.replace('T',' '))}${renderDetailRow("ÂÖßÂÆπ", r.section?.[0]?.text?.div, true)}`);
        };
        async function loadLab(ptId, divId, wrapId) { await loadReport(ptId, divId, wrapId, 'LAB', 'lab'); }
        async function loadExam(ptId, divId, wrapId) { await loadReport(ptId, divId, wrapId, 'RAD', 'exam'); }
        async function loadReport(ptId, divId, wrapId, cat, key) {
            try {
                const data = await fhirClient.request(`DiagnosticReport?patient=${ptId}&category=${cat}&_sort=-date&_include=DiagnosticReport:result`);
                const reports = (data.entry || []).filter(e => e.resource.resourceType === 'DiagnosticReport');
                const obsMap = {};
                (data.entry || []).forEach(e => { if(e.resource.resourceType==='Observation') obsMap[`Observation/${e.resource.id}`] = e.resource; });
                currentPatientResources[key] = reports.map(e => ({ report: e.resource, obs: (e.resource.result || []).map(ref => obsMap[ref.reference]) }));
                const html = reports.map((e, idx) => `<div class="data-card" onclick="showReportDetail('${key}', ${idx})"><div class="data-row"><b>${e.resource.code?.text}</b> <span>${e.resource.effectiveDateTime?.split('T')[0]}</span></div></div>`).join('');
                updateUI(wrapId, divId, html, reports.length);
            } catch (e) { updateUI(wrapId, divId, e.message, 0, true); }
        }
        window.showReportDetail = (key, idx) => {
            const item = currentPatientResources[key][idx];
            let obsHtml = item.obs.map(o => o ? `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px 0;"><span>${o.code?.text}</span><b>${o.valueQuantity ? o.valueQuantity.value + ' ' + o.valueQuantity.unit : o.valueString || '-'}</b></div>` : '').join('');
            openModal("Â†±ÂëäÂÖßÂÆπ", `${renderDetailRow("È†ÖÁõÆ", item.report.code?.text)}${renderDetailRow("ÁµêË´ñ", item.report.conclusion)}${renderDetailRow("Êï∏ÂÄº", obsHtml, true)}`);
        };
        async function loadSurgery(ptId, divId, wrapId) {
            simpleLoad(ptId, divId, wrapId, 'Procedure?category=surgical&_sort=-date', 'surgery',
                (r) => `<div class="data-row"><b>${r.code?.text}</b> <span>${r.performedDateTime?.split('T')[0]}</span></div>`,
                (r) => `${renderDetailRow("Ë°ìÂºè", r.code?.text)}${renderDetailRow("Êó•Êúü", r.performedDateTime)}${renderDetailRow("ÁôºÁèæ", r.outcome?.text)}`, "ÊâãË°ìÁ¥ÄÈåÑ"
            );
        }
        async function loadConsult(ptId, divId, wrapId) {
            simpleLoad(ptId, divId, wrapId, 'ServiceRequest?category=consult&_sort=-authored', 'consult',
                (r) => `<div class="data-row"><b>${r.performerType?.text || 'Consult'}</b> <span>${r.authoredOn}</span></div>`,
                (r) => `${renderDetailRow("ÁßëÂà•", r.performerType?.text)}${renderDetailRow("Ë¢´ÊúÉÈÜ´Â∏´", r.performer?.[0]?.display)}${renderDetailRow("ÂéüÂõ†", r.reasonCode?.[0]?.text)}`, "ÊúÉË®∫Á¥ÄÈåÑ"
            );
        }
        async function loadRecords(ptId, divId, wrapId) {
            simpleLoad(ptId, divId, wrapId, 'Composition?_sort=-date', 'records',
                (r) => `<div class="data-row"><b>${r.type?.text}</b> <span>${r.date?.split('T')[0]}</span></div>`,
                (r) => `${renderDetailRow("Ê®ôÈ°å", r.type?.text)}${renderDetailRow("ÂÖßÂÆπ", r.section?.[0]?.text?.div, true)}`, "ÁóÖÊ≠∑Á¥ÄÈåÑ"
            );
        }
        async function simpleLoad(ptId, divId, wrapId, query, key, listRender, detailRender, modalTitle) {
            try {
                const url = query.startsWith('http') ? query : `${query}&patient=${ptId}`;
                const data = await fhirClient.request(url);
                const list = data.entry || [];
                currentPatientResources[key] = list.map(e => e.resource);
                const html = list.map((e, idx) => `<div class="data-card" onclick="showGenDetail('${key}', ${idx})">${listRender(e.resource)}</div>`).join('');
                updateUI(wrapId, divId, html, list.length);
                window[`render_${key}`] = (r) => openModal(modalTitle, detailRender(r));
            } catch (e) { updateUI(wrapId, divId, e.message, 0, true); }
        }
        window.showGenDetail = (key, idx) => { window[`render_${key}`](currentPatientResources[key][idx]); };

        function updateUI(wrapId, divId, html, count, isError=false) {
            const w = document.getElementById(wrapId);
            const c = document.getElementById(divId);
            c.innerHTML = html;
            w.classList.remove('no-data', 'error-state');
            if(isError) { w.classList.add('error-state'); c.innerHTML = `<div class="error">ËºâÂÖ•ÈåØË™§: ${html}</div>`; }
            else if(count===0) { w.classList.add('no-data'); c.innerHTML = '<div class="empty">Êü•ÁÑ°Ë≥áÊñô</div>'; }
        }
    </script>

</body>

